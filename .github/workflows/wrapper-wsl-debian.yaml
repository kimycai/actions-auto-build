name: Build wrapper on WSL Debian

on:

  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream repository branch to build'
        required: false
        default: 'main'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout upstream repository
      uses: actions/checkout@v4
      with:
        repository: WorldObservationLog/wrapper
        path: wrapper-main
        ref: ${{ github.event.inputs.upstream_branch || 'main' }}

    - name: Checkout wrapper-wsl-debian repository
      uses: actions/checkout@v4
      with:
        repository: kimycai/wrapper-wsl-debian
        token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
        path: wrapper-wsl-debian

    - name: Enable WSL and install Debian
      run: |
        wsl --install -d Debian --no-launch
        wsl --set-default Debian
        # Wait for WSL to be ready
        Start-Sleep -Seconds 10

    - name: Update WSL Debian and install dependencies
      run: |
        wsl -u root -d Debian apt update
        wsl -u root -d Debian apt upgrade -y
        wsl -u root -d Debian apt install -y build-essential cmake wget unzip git lsb-release

    - name: Install LLVM in WSL Debian
      run: |
        wsl -u root -d Debian bash -c "wget -O - https://apt.llvm.org/llvm.sh | bash"

    - name: Download and install Android NDK in WSL Debian
      run: |
        wsl -d Debian wget -O android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
        wsl -d Debian unzip -q -d ~ android-ndk-r23b-linux.zip

    - name: Build project in WSL Debian
      run: |
        cd wrapper-main
        wsl -d Debian mkdir -p build
        wsl -d Debian bash -c "cd build && cmake .. && make -j$(nproc)"

    - name: Copy all build artifacts to wrapper-wsl-debian directory
      run: |
        # Copy wrapper executable
        if (Test-Path -Path "wrapper-main\wrapper" -PathType Leaf) {
          Copy-Item -Path "wrapper-main\wrapper" -Destination "wrapper-wsl-debian\" -Force
        }
        # Copy entire rootfs directory
        if (Test-Path -Path "wrapper-main\rootfs" -PathType Container) {
          Copy-Item -Path "wrapper-main\rootfs" -Destination "wrapper-wsl-debian\" -Recurse -Force
        }

    - name: Configure Git for wrapper-wsl-debian repository
      run: |
        cd wrapper-wsl-debian
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Commit and push to wrapper-wsl-debian repository
      run: |
        cd wrapper-wsl-debian
        # Check if there are any changes to commit
        if ((git status --porcelain | Measure-Object).Count -gt 0) {
          # Add all changes
          git add .
          # Commit changes
          git commit -m "Build: Update wrapper-wsl-debian directory with latest build artifacts [skip ci]"
          # Push to repository
          git push origin HEAD:main
        } else {
          Write-Host "No changes to commit"
        }
