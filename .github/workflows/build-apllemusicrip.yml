name: Build apple-music-rip (Ubuntu 24.04)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # 手动触发，优先级最高

# 并发控制：避免同分支重复构建，节省资源
concurrency:
  group: ${{ github.ref }}-apple-music-rip-ubuntu2404
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04 # 固定Ubuntu 24.04官方运行器
    steps:
      - name: 1. 强制检出原项目完整代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 浅克隆加速
          repository: HARAJIT05/apple-music-rip # 强制拉取原项目
          ref: main # 原项目主分支
          path: . # 根目录检出，无嵌套

      - name: 2. 修复Ubuntu 24.04依赖锁&更新软件源
        run: |
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo dpkg --configure -a
          sudo apt update -y && sudo apt upgrade -y --no-install-recommends
          sudo apt clean

      - name: 3. 安装项目必要系统依赖（无Java、无冗余）
        run: |
          sudo apt install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            zip \
            python3 \
            python3-pip \
            python3-venv \
            libssl-dev \
            pkg-config \
            golang-go \
            net-tools
          sudo apt autoremove -y && sudo apt clean
          echo "Python版本：$(python3 --version)"
          echo "Go版本：$(go version)"

      - name: 4. 配置Python虚拟环境&安装Web核心依赖
        run: |
          cd $GITHUB_WORKSPACE
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install flask==2.3.3 flask-cors==4.0.0 requests==2.31.0
          pip freeze > requirements.txt

      - name: 5. 彻底移除Nix相关逻辑
        run: |
          cd $GITHUB_WORKSPACE
          if [ ! -f "main.py" ]; then
            echo "❌ 未找到main.py"
            ls -la
            exit 1
          fi
          echo "✅ 开始清理Nix相关代码"
          sed -i '/install_nix/d' main.py
          sed -i '/nix-shell/d' main.py
          sed -i '/Nix\|nix/d' main.py
          if grep -q -i "nix" main.py; then
            echo "❌ 检测到Nix代码残留"
            exit 1
          fi
          echo "✅ Nix相关逻辑清理完成"
        shell: /usr/bin/bash -e {0}

      - name: 6. 项目初始化（自动拉取核心工具）
        run: |
          cd $GITHUB_WORKSPACE
          source .venv/bin/activate
          chmod +x main.py
          python3 main.py 2>&1 &
          sleep 3
          pkill -f "python3 main.py" || echo "服务已停止"
          echo "✅ 核心工具拉取完成"

      - name: 7. 打包完整可运行产物（核心修复：统一路径+固定命名）
        run: |
          cd $GITHUB_WORKSPACE
          # 创建产物目录
          mkdir -p dist
          # 复制所有核心文件（容错处理缺失目录）
          cp -r app/ main.py requirements.txt dist/ 2>/dev/null
          cp -r .venv/ dist/ 2>/dev/null
          cp -r apple-music-downloader/ dist/ 2>/dev/null || echo "⚠️ apple-music-downloader目录暂未生成"
          cp -r wrapper/ dist/ 2>/dev/null || echo "⚠️ wrapper目录暂未生成"
          # 定义固定压缩包名称（避免SHA拼接歧义，同时保留版本追溯）
          PACKAGE_NAME="apple-music-rip-ubuntu2404-build.zip"
          # 打包（指定根目录，确保路径唯一）
          zip -r "${PACKAGE_NAME}" dist/
          # 核心：校验压缩包是否生成成功
          if [ ! -f "${PACKAGE_NAME}" ]; then
            echo "❌ 产物打包失败，未生成压缩包"
            ls -lh
            exit 1
          fi
          # 打印产物信息，便于日志排查
          ls -lh "${PACKAGE_NAME}"
          echo "✅ 产物打包完成：${PACKAGE_NAME}"
          # 导出变量，供后续上传步骤使用（绝对统一，无匹配错误）
          echo "PACKAGE_PATH=$GITHUB_WORKSPACE/${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: 8. 上传构建产物（核心修复：使用环境变量，精准匹配文件）
        uses: actions/upload-artifact@v4
        with:
          name: apple-music-rip-ubuntu2404-build
          path: ${{ env.PACKAGE_PATH }} # 使用上一步导出的绝对路径，100%匹配
          retention-days: 90
          if-no-files-found: error # 无文件直接失败，及时发现问题

      - name: 9. 验证产物基础运行
        run: |
          cd $GITHUB_WORKSPACE/dist
          source .venv/bin/activate
          python3 main.py 2>&1 > run.log &
          sleep 5
          if netstat -tulpn | grep -q 5000; then
            echo "✅ 产物验证成功：5000端口已监听"
          else
            echo "❌ 产物验证失败，运行日志："
            cat run.log
            exit 1
          fi
          pkill -f "python3 main.py"
