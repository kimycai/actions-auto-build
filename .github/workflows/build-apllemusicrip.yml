name: Build apple-music-rip (Ubuntu 24.04)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œä¼˜å…ˆçº§æœ€é«˜

# å¹¶å‘æŽ§åˆ¶ï¼šé¿å…åŒåˆ†æ”¯é‡å¤æž„å»º
concurrency:
  group: ${{ github.ref }}-apple-music-rip-ubuntu2404
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04 # å›ºå®šUbuntu 24.04è¿è¡Œå™¨
    steps:
      - name: 1. å¼ºåˆ¶æ£€å‡ºåŽŸé¡¹ç›®å®Œæ•´ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          repository: HARAJIT05/apple-music-rip
          ref: main
          path: .

      - name: 2. ä¿®å¤Ubuntu 24.04ä¾èµ–é”&æ›´æ–°æº
        run: |
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo dpkg --configure -a
          sudo apt update -y && sudo apt upgrade -y --no-install-recommends
          sudo apt clean

      - name: 3. å®‰è£…é¡¹ç›®å¿…è¦ç³»ç»Ÿä¾èµ–ï¼ˆæ— Javaã€æ— å†—ä½™ï¼‰
        run: |
          sudo apt install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            zip \
            python3 \
            python3-pip \
            python3-venv \
            libssl-dev \
            pkg-config \
            golang-go \
            net-tools
          sudo apt autoremove -y && sudo apt clean
          echo "Pythonç‰ˆæœ¬ï¼š$(python3 --version)"
          echo "Goç‰ˆæœ¬ï¼š$(go version)"

      - name: 4. é…ç½®Pythonè™šæ‹ŸçŽ¯å¢ƒ&å®‰è£…Webä¾èµ–
        run: |
          cd $GITHUB_WORKSPACE
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install flask==2.3.3 flask-cors==4.0.0 requests==2.31.0
          pip freeze > requirements.txt

      - name: 5. ç§»é™¤Nixç›¸å…³é€»è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šæ³¨é‡Šæ›¿ä»£åˆ é™¤ï¼Œä¿ç•™ç¼©è¿›ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          # æ ¡éªŒmain.pyå­˜åœ¨æ€§
          if [ ! -f "main.py" ]; then
            echo "âŒ æœªæ‰¾åˆ°main.py"
            ls -la
            exit 1
          fi
          echo "âœ… å¼€å§‹å¤„ç†Nixç›¸å…³ä»£ç ï¼ˆæ³¨é‡Šè€Œéžåˆ é™¤ï¼Œä¿ç•™ç¼©è¿›ï¼‰"
          # å…³é”®ä¿®æ”¹ï¼šç”¨#æ³¨é‡Šå«Nixå…³é”®å­—çš„è¡Œï¼Œä¸åˆ é™¤è¡Œï¼Œé¿å…ç¼©è¿›ç»“æž„ç ´å
          sed -i '/install_nix/s/^/#/' main.py
          sed -i '/nix-shell/s/^/#/' main.py
          sed -i '/nix\|Nix/s/^/#/' main.py
          # éªŒè¯ï¼šä»…æ£€æŸ¥æ˜¯å¦æœ‰æœªæ³¨é‡Šçš„Nixä»£ç ï¼Œä¸å¼ºåˆ¶åˆ é™¤è¡Œ
          if grep -q -i "^[^#].*nix" main.py; then
            echo "âŒ æ£€æµ‹åˆ°æœªæ³¨é‡Šçš„Nixç›¸å…³ä»£ç "
            grep -n -i "^[^#].*nix" main.py
            exit 1
          fi
          echo "âœ… Nixç›¸å…³ä»£ç å·²å…¨éƒ¨æ³¨é‡Šï¼Œç¼©è¿›ç»“æž„ä¿æŒå®Œæ•´"
        shell: /usr/bin/bash -e {0}

      - name: 6. é¡¹ç›®åˆå§‹åŒ–ï¼ˆè‡ªåŠ¨æ‹‰å–æ ¸å¿ƒå·¥å…·ï¼Œä¸å¯åŠ¨æœåŠ¡ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          source .venv/bin/activate
          chmod +x main.py
          # åˆå§‹åŒ–å·¥å…·æ‹‰å–ï¼Œè¶…æ—¶10ç§’ç¡®ä¿å®Œæˆ
          python3 main.py 2>&1 &
          sleep 10
          # å®‰å…¨åœæ­¢æœåŠ¡ï¼Œé¿å…æŒ‚èµ·
          pkill -f "python3 main.py" || echo "æœåŠ¡å·²æ­£å¸¸åœæ­¢"
          echo "âœ… æ ¸å¿ƒå·¥å…·æ‹‰å–å®Œæˆ"

      - name: 7. æ‰“åŒ…å®Œæ•´å¯è¿è¡Œäº§ç‰©ï¼ˆç»Ÿä¸€è·¯å¾„+çŽ¯å¢ƒå˜é‡å¯¼å‡ºï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p dist
          # å®¹é”™å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶ï¼Œé¿å…ç¼ºå¤±ç›®å½•ä¸­æ–­æ‰“åŒ…
          cp -r app/ main.py requirements.txt dist/ 2>/dev/null
          cp -r .venv/ dist/ 2>/dev/null
          cp -r apple-music-downloader/ dist/ 2>/dev/null || echo "âš ï¸ apple-music-downloaderç›®å½•æš‚æœªç”Ÿæˆ"
          cp -r wrapper/ dist/ 2>/dev/null || echo "âš ï¸ wrapperç›®å½•æš‚æœªç”Ÿæˆ"
          # å®šä¹‰å›ºå®šäº§ç‰©åç§°ï¼Œé¿å…SHAæ‹¼æŽ¥é—®é¢˜
          PACKAGE_NAME="apple-music-rip-ubuntu2404-build.zip"
          # æ‰“åŒ…å¹¶åŽ‹ç¼©
          zip -r "${PACKAGE_NAME}" dist/
          # æ ¡éªŒäº§ç‰©æ˜¯å¦ç”Ÿæˆ
          if [ ! -f "${PACKAGE_NAME}" ]; then
            echo "âŒ äº§ç‰©æ‰“åŒ…å¤±è´¥ï¼Œæœªç”ŸæˆåŽ‹ç¼©åŒ…"
            ls -lh
            exit 1
          fi
          # å¯¼å‡ºäº§ç‰©ç»å¯¹è·¯å¾„ï¼Œä¾›ä¸Šä¼ ä½¿ç”¨
          echo "PACKAGE_PATH=$GITHUB_WORKSPACE/${PACKAGE_NAME}" >> $GITHUB_ENV
          ls -lh "${PACKAGE_NAME}"
          echo "âœ… äº§ç‰©æ‰“åŒ…å®Œæˆï¼š${PACKAGE_NAME}"

      - name: 8. ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼Œç²¾å‡†åŒ¹é…ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: apple-music-rip-ubuntu2404-build
          path: ${{ env.PACKAGE_PATH }}
          retention-days: 90
          if-no-files-found: error

      - name: 9. éªŒè¯äº§ç‰©è¿è¡Œï¼ˆä¿®å¤Pythonå¯åŠ¨+ç«¯å£æ£€æŸ¥ï¼‰
        run: |
          cd $GITHUB_WORKSPACE/dist
          source .venv/bin/activate
          # å…³é”®ï¼šæ·»åŠ Pythonè¯­æ³•æ£€æŸ¥ï¼Œæå‰å‘çŽ°ç¼©è¿›/è¯­æ³•é”™è¯¯
          echo "ðŸ” å…ˆæ‰§è¡ŒPythonè¯­æ³•æ£€æŸ¥ï¼ŒæŽ’æŸ¥ä»£ç é”™è¯¯"
          python3 -m py_compile main.py
          if [ $? -ne 0 ]; then
            echo "âŒ main.pyè¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œå­˜åœ¨ç¼©è¿›/è¯­æ³•é”™è¯¯"
            exit 1
          fi
          echo "âœ… main.pyè¯­æ³•æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹å¯åŠ¨é¡¹ç›®"
          # åŽå°å¯åŠ¨é¡¹ç›®ï¼Œé‡å®šå‘æ‰€æœ‰æ—¥å¿—
          python3 main.py 2>&1 > run.log &
          sleep 8 # å»¶é•¿å¯åŠ¨æ—¶é—´ï¼Œç¡®ä¿FlaskæœåŠ¡å®Œå…¨åŠ è½½
          # ç«¯å£æ£€æŸ¥ï¼ˆå…¼å®¹éžrootæƒé™ï¼Œä»…è¿‡æ»¤python3è¿›ç¨‹ï¼‰
          if netstat -tulpn 2>/dev/null | grep -E "(:5000).*python3"; then
            echo "âœ… äº§ç‰©éªŒè¯æˆåŠŸï¼š5000ç«¯å£å·²è¢«Python3ç›‘å¬"
          else
            echo "âŒ äº§ç‰©éªŒè¯å¤±è´¥ï¼Œè¿è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            cat run.log || echo "æ— è¿è¡Œæ—¥å¿—"
            exit 1
          fi
          # å®‰å…¨åœæ­¢æœåŠ¡
          pkill -f "python3 main.py" 2>/dev/null
        shell: /usr/bin/bash -e {0}
