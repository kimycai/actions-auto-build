name: Build apple-music-rip (Ubuntu 24.04)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œä¼˜å…ˆçº§æœ€é«˜

# å¹¶å‘æŽ§åˆ¶ï¼šé¿å…åŒåˆ†æ”¯é‡å¤æž„å»º
concurrency:
  group: ${{ github.ref }}-apple-music-rip-ubuntu2404
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04 # å›ºå®šUbuntu 24.04å®˜æ–¹è¿è¡Œå™¨
    steps:
      - name: 1. å¼ºåˆ¶æ£€å‡ºåŽŸé¡¹ç›®å®Œæ•´ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          repository: HARAJIT05/apple-music-rip
          ref: main
          path: .

      - name: 2. ä¿®å¤Ubuntu 24.04ä¾èµ–é”&æ›´æ–°è½¯ä»¶æº
        run: |
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo dpkg --configure -a
          sudo apt update -y && sudo apt upgrade -y --no-install-recommends
          sudo apt clean

      - name: 3. å®‰è£…é¡¹ç›®å¿…è¦ç³»ç»Ÿä¾èµ–ï¼ˆæ— Javaã€æ— å†—ä½™ï¼‰
        run: |
          sudo apt install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            zip \
            python3 \
            python3-pip \
            python3-venv \
            libssl-dev \
            pkg-config \
            golang-go \
            net-tools
          sudo apt autoremove -y && sudo apt clean
          echo "Pythonç‰ˆæœ¬ï¼š$(python3 --version)"
          echo "Goç‰ˆæœ¬ï¼š$(go version)"

      - name: 4. é…ç½®Pythonè™šæ‹ŸçŽ¯å¢ƒ&å®‰è£…Webæ ¸å¿ƒä¾èµ–
        run: |
          cd $GITHUB_WORKSPACE
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install flask==2.3.3 flask-cors==4.0.0 requests==2.31.0
          pip freeze > requirements.txt

      - name: 5. æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢ä¸ºæ— Nixã€ç¼©è¿›åˆè§„çš„main.pyï¼ˆä¿®å¤YAMLè¯­æ³•ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          # å¤‡ä»½åŽŸmain.pyï¼ˆä¾¿äºŽæº¯æºï¼‰
          mv main.py main.py.bak
          # å…³é”®ä¿®å¤ï¼šEOFå‰åŽå‡ç”¨å•å¼•å·åŒ…è£¹ï¼ŒYAMLå¤šè¡Œå­—ç¬¦ä¸²è¯­æ³•åˆè§„
          cat > main.py << 'EOF'
import os
import subprocess
import sys
from app import create_app

app = create_app()

# æ£€æŸ¥å¿…è¦çš„ç³»ç»Ÿä¾èµ–
def check_dependencies():
    required_tools = ["git", "go", "python3", "pip3"]
    missing = []
    for tool in required_tools:
        if subprocess.call(["which", tool], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) != 0:
            missing.append(tool)
    if missing:
        print(f"âŒ ç¼ºå°‘å¿…è¦ä¾èµ–ï¼š{', '.join(missing)}ï¼Œè¯·å…ˆå®‰è£…")
        sys.exit(1)
    print("âœ… æ‰€æœ‰ç³»ç»Ÿä¾èµ–æ£€æŸ¥é€šè¿‡")

# æ‹‰å–apple-music-downloaderæ ¸å¿ƒå·¥å…·
def pull_downloader():
    if not os.path.exists("apple-music-downloader"):
        print("ðŸ” æ­£åœ¨æ‹‰å–apple-music-downloaderæ ¸å¿ƒå·¥å…·...")
        subprocess.run(["git", "clone", "https://github.com/zhaarey/apple-music-downloader.git"], check=True)
        print("âœ… apple-music-downloaderæ‹‰å–å®Œæˆ")
    else:
        print("âœ… apple-music-downloaderå·²å­˜åœ¨ï¼Œæ— éœ€é‡æ–°æ‹‰å–")

# æ‹‰å–wrapperé‰´æƒå·¥å…·
def pull_wrapper():
    if not os.path.exists("wrapper"):
        print("ðŸ” æ­£åœ¨æ‹‰å–wrapperé‰´æƒå·¥å…·...")
        subprocess.run(["git", "clone", "https://github.com/WorldObservationLog/wrapper.git"], check=True)
        print("âœ… wrapperæ‹‰å–å®Œæˆ")
    else:
        print("âœ… wrapperå·²å­˜åœ¨ï¼Œæ— éœ€é‡æ–°æ‹‰å–")

# åˆå§‹åŒ–é¡¹ç›®ï¼ˆæ‹‰å–æ‰€æœ‰æ ¸å¿ƒå·¥å…·ï¼‰
def init_project():
    check_dependencies()
    pull_downloader()
    pull_wrapper()
    print("ðŸŽ‰ é¡¹ç›®åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰æ ¸å¿ƒå·¥å…·å·²å°±ç»ª")

if __name__ == "__main__":
    # åˆå§‹åŒ–é¡¹ç›®
    init_project()
    # å¯åŠ¨Flask WebæœåŠ¡ï¼ˆé»˜è®¤ç«¯å£5000ï¼Œæ‰€æœ‰IPå¯è®¿é—®ï¼‰
    app.run(host="0.0.0.0", port=5000, debug=False)
EOF
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x main.py
          # éªŒè¯æ–°main.pyè¯­æ³•ï¼ˆæå‰æ‹¦æˆªé—®é¢˜ï¼‰
          python3 -m py_compile main.py
          if [ $? -eq 0 ]; then
            echo "âœ… æ–°main.pyåˆ›å»ºæˆåŠŸï¼Œè¯­æ³•æ£€æŸ¥é€šè¿‡ï¼ˆæ— ç¼©è¿›/nixé”™è¯¯ï¼‰"
          else
            echo "âŒ æ–°main.pyè¯­æ³•é”™è¯¯"
            exit 1
          fi
        shell: /usr/bin/bash -e {0}

      - name: 6. é¡¹ç›®åˆå§‹åŒ–ï¼ˆæ‹‰å–æ ¸å¿ƒå·¥å…·ï¼Œæ— å¯åŠ¨æŒ‚èµ·é£Žé™©ï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          source .venv/bin/activate
          # ä»…æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼Œä¸æ‹‰å–æœåŠ¡ï¼Œç¨³å®šæ— æŠ¥é”™
          python3 -c "from main import init_project; init_project()"
          echo "âœ… æ ¸å¿ƒå·¥å…·ï¼ˆapple-music-downloader/wrapperï¼‰æ‹‰å–å®Œæˆ"

      - name: 7. æ‰“åŒ…å®Œæ•´å¯è¿è¡Œäº§ç‰©ï¼ˆç»Ÿä¸€è·¯å¾„+çŽ¯å¢ƒå˜é‡å¯¼å‡ºï¼‰
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p dist
          # å®¹é”™å¤åˆ¶æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶ï¼Œé¿å…ç¼ºå¤±ç›®å½•ä¸­æ–­æ‰“åŒ…
          cp -r app/ main.py requirements.txt dist/ 2>/dev/null
          cp -r .venv/ dist/ 2>/dev/null
          cp -r apple-music-downloader/ dist/ 2>/dev/null
          cp -r wrapper/ dist/ 2>/dev/null
          # å®šä¹‰å›ºå®šäº§ç‰©åç§°ï¼Œé¿å…è·¯å¾„è§£æžé—®é¢˜
          PACKAGE_NAME="apple-music-rip-ubuntu2404-build.zip"
          zip -r "${PACKAGE_NAME}" dist/
          # æ ¡éªŒäº§ç‰©æ˜¯å¦ç”Ÿæˆï¼Œæå‰æ‹¦æˆªå¤±è´¥
          if [ ! -f "${PACKAGE_NAME}" ]; then
            echo "âŒ äº§ç‰©æ‰“åŒ…å¤±è´¥ï¼Œæœªç”ŸæˆåŽ‹ç¼©åŒ…"
            ls -lh
            exit 1
          fi
          # å¯¼å‡ºäº§ç‰©ç»å¯¹è·¯å¾„ï¼Œä¾›ä¸Šä¼ æ­¥éª¤ä½¿ç”¨
          echo "PACKAGE_PATH=$GITHUB_WORKSPACE/${PACKAGE_NAME}" >> $GITHUB_ENV
          ls -lh "${PACKAGE_NAME}"
          echo "âœ… äº§ç‰©æ‰“åŒ…å®Œæˆï¼š${PACKAGE_NAME}"

      - name: 8. ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆç²¾å‡†åŒ¹é…è·¯å¾„ï¼Œæ— ä¸Šä¼ å¤±è´¥ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: apple-music-rip-ubuntu2404-build
          path: ${{ env.PACKAGE_PATH }}
          retention-days: 90
          if-no-files-found: error

      - name: 9. éªŒè¯äº§ç‰©è¿è¡Œï¼ˆè¯­æ³•æ£€æŸ¥+ç²¾å‡†ç«¯å£éªŒè¯ï¼‰
        run: |
          cd $GITHUB_WORKSPACE/dist
          source .venv/bin/activate
          # ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶Pythonè¯­æ³•æ£€æŸ¥ï¼ŒåŒé‡ä¿éšœ
          echo "ðŸ” æ‰§è¡ŒPythonè¯­æ³•æ£€æŸ¥"
          python3 -m py_compile main.py
          if [ $? -ne 0 ]; then
            echo "âŒ main.pyè¯­æ³•æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          echo "âœ… main.pyè¯­æ³•æ£€æŸ¥é€šè¿‡"
          # ç¬¬äºŒæ­¥ï¼šåŽå°å¯åŠ¨é¡¹ç›®ï¼Œé‡å®šå‘æ‰€æœ‰æ—¥å¿—
          python3 main.py 2>&1 > run.log &
          sleep 8 # å»¶é•¿å¯åŠ¨æ—¶é—´ï¼Œç¡®ä¿FlaskæœåŠ¡å®Œå…¨åŠ è½½
          # ç¬¬ä¸‰æ­¥ï¼šç²¾å‡†æ£€æŸ¥5000ç«¯å£ï¼ˆä»…åŒ¹é…Python3è¿›ç¨‹ï¼Œé¿å…å¹²æ‰°ï¼‰
          if netstat -tulpn 2>/dev/null | grep -E "(:5000).*python3"; then
            echo "âœ… äº§ç‰©éªŒè¯æˆåŠŸï¼š5000ç«¯å£å·²è¢«Python3ç›‘å¬"
          else
            echo "âŒ äº§ç‰©éªŒè¯å¤±è´¥ï¼Œè¿è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            cat run.log || echo "æ— è¿è¡Œæ—¥å¿—"
            exit 1
          fi
          # å®‰å…¨åœæ­¢æœåŠ¡ï¼Œå±è”½æ— å…³æç¤º
          pkill -f "python3 main.py" 2>/dev/null
        shell: /usr/bin/bash -e {0}
