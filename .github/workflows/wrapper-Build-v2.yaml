name: wrapper-Build-Push-SelfRepo
on:
  workflow_dispatch:  # 仅手动触发，按需添加 push 自动触发

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 1. 拉取官方wrapper源码到CI环境
      - name: Checkout WorldObservationLog/wrapper source code
        uses: actions/checkout@v4
        with:
          repository: WorldObservationLog/wrapper
          path: wrapper
          fetch-depth: 1

      # 2. 安装编译依赖（Ubuntu24.04兼容）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y aria2 build-essential cmake wget unzip git
          sudo apt update --fix-missing -y

      # 3. 安装LLVM（与官方编译规则一致）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 4. 配置Android NDK r23b
      - name: Set up Android NDK r23b
        run: | 
          aria2c -o android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip
        working-directory: wrapper

      # 5. 配置NDK环境变量
      - name: Set ANDROID_NDK_HOME
        run: echo "ANDROID_NDK_HOME=~/android-ndk-r23b" >> $GITHUB_ENV

      # 6. 核心编译：生成wrapper可执行文件
      - name: Build wrapper executable
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j$(nproc)
        working-directory: wrapper

      # 7. 校验产物：确保wrapper存在且有可执行权限
      - name: Verify wrapper executable
        run: |
          EXEC_PATH="wrapper/wrapper"
          if [ ! -x "$EXEC_PATH" ]; then
            echo "ERROR: wrapper可执行文件不存在或无执行权限！"
            exit 1
          fi
          echo "✅ 编译产物验证通过：$EXEC_PATH"
          ls -l $EXEC_PATH

      # -------------------------- 以下是你验证通过的推送逻辑（仅适配仓库/路径） --------------------------
      - name: Configure Git identity (for push)
        run: |
          # 配置Git用户名和邮箱，Actions推送仓库必备（你原验证逻辑）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Checkout self repository (kimycai/amdl-web-manager)
        uses: actions/checkout@v4
        with:
          repository: kimycai/amdl-web-manager  # 改为你的自仓地址
          ref: main                              # 推送到自仓main分支（按需改master）
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }} # 你已配置的专属令牌
          path: wrapper-push                     # 保持你原隔离目录，无冲突
          fetch-depth: 1                         # 浅克隆，提升速度

      - name: Copy wrapper & push to self repo
        run: |
          # 复制编译好的wrapper到仓库目录，-p保留可执行权限（关键）
          cp -rp wrapper/wrapper wrapper-push/
          # 进入仓库目录（你原逻辑）
          cd wrapper-push
          # 验证复制结果，确认文件存在（你原逻辑）
          ls -lh .
          # 提交变更，无修改则跳过（避免报错，你原逻辑）
          git add .
          git commit -m "Auto update wrapper [Ubuntu24.04 build] - ${GITHUB_SHA:0:7}" || echo "No changes to commit"
          # 推送到自仓远程分支（你原验证通过的推送命令）
          git push origin main
