name: wrapper-Build-v1 sucessful
on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-24.04  # Ubuntu 24.04构建环境
    steps:
      # 1. 拉取官方源码到CI根目录wrapper/子目录
      - name: Checkout WorldObservationLog/wrapper source code
        uses: actions/checkout@v4
        with:
          repository: WorldObservationLog/wrapper
          path: wrapper
          fetch-depth: 1

      # 2. 安装编译依赖（兼容官方+Ubuntu24.04新环境）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y aria2 build-essential cmake wget unzip git
          sudo apt update --fix-missing -y

      # 3. 安装LLVM（与官方一致）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 4. 配置Android NDK r23b（aria2c下载，与官方一致）
      - name: Set up Android NDK r23b
        run: | 
          aria2c -o android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip
        working-directory: wrapper

      # 5. 显式配置NDK环境变量（Ubuntu24.04兼容性）
      - name: Set ANDROID_NDK_HOME
        run: echo "ANDROID_NDK_HOME=~/android-ndk-r23b" >> $GITHUB_ENV

      # 6. 核心构建流程（与官方一致，多核编译优化）
      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j$(nproc)
        working-directory: wrapper

      # 7. 校验wrapper可执行文件（存在+可执行权限，精准路径）
      - name: Verify wrapper executable exists
        run: |
          EXEC_PATH="wrapper/wrapper"
          if [ ! -x "$EXEC_PATH" ]; then
            echo "ERROR: wrapper可执行文件不存在，路径：$EXEC_PATH"
            exit 1
          fi
          echo "✅ 产物验证通过：$EXEC_PATH（存在且具备可执行权限）"
          ls -l $EXEC_PATH  # 输出文件信息，日志可查

      # 8. 上传wrapper作为GitHub Action产物（备用，可手动下载）
      - name: Upload wrapper executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: wrapper-executable-ubuntu2404
          path: wrapper/wrapper

      # 9. 核心修复：直接推送wrapper到Gitee（解决鉴权问题，API方式）
      - name: Push wrapper directly to Gitee (kimycai/amdl-web-manager)
        run: |
          # 定义关键参数（已替换你的信息，无需修改）
          GITEE_USER="kimycai"
          GITEE_REPO="amdl-web-manager"
          GITEE_BRANCH="main"  # 推送目标分支，可改为master（若需）
          FILE_PATH="wrapper"  # 仓库中文件路径（根目录wrapper）
          COMMIT_MSG="Auto update wrapper executable [Ubuntu24.04 build]"
          # 读取Gitee令牌（从GitHub Secrets中正确解析）
          GITEE_TOKEN="${{ secrets.GITEE_TOKEN }}"
          
          # 将可执行文件转为Base64编码（Gitee API要求，不换行）
          FILE_CONTENT=$(base64 -w 0 wrapper/wrapper)
          
          # 调用Gitee API：创建/更新文件（修复access_token传递方式，双重鉴权）
          curl -X PUT "https://gitee.com/api/v5/repos/${GITEE_USER}/${GITEE_REPO}/contents/${FILE_PATH}" \
            -H "Content-Type: application/json" \
            -H "Authorization: token ${GITEE_TOKEN}" \
            -d "{
              \"access_token\": \"${GITEE_TOKEN}\",
              \"branch\": \"${GITEE_BRANCH}\",
              \"content\": \"${FILE_CONTENT}\",
              \"message\": \"${COMMIT_MSG}\"
            }" -v  # -v：开启详细日志，便于排查问题（可选，建议保留）
          
          echo -e "\n✅ 若上述curl无401/403错误，wrapper已成功推送到Gitee仓库！"
          echo "仓库地址：https://gitee.com/${GITEE_USER}/${GITEE_REPO}/blob/${GITEE_BRANCH}/${FILE_PATH}"
