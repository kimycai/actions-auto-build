name: Build and Push Docker Image

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: WorldObservationLog/AppleMusicDecrypt
        ref: main

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update README with Docker instructions
      run: |
        cat >> README.md << 'EOF'
        
        ## Docker Usage
        
        ### Pull the image
        ```bash
        docker pull ghcr.io/${{ github.repository }}:latest
        ```
        
        ### Run interactively
        ```bash
        docker run -it --rm \
          -v $(pwd)/downloads:/app/downloads \
          -v $(pwd)/config.toml:/app/config.toml \
          ghcr.io/${{ github.repository }}:latest
        ```
        
        ### Example commands inside container
        ```bash
        dl https://music.apple.com/jp/album/nameless-name-single/1688539265
        dl -c aac https://music.apple.com/jp/song/caribbean-blue/339592231
        ```
        EOF

    - name: Commit and push README updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "docs: Add Docker usage instructions" || exit 0
        git push

  test-image:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull and test Docker image
      run: |
        # Pull the latest image
        docker pull ghcr.io/${{ github.repository }}:latest
        
        # Test basic functionality
        docker run --rm ghcr.io/${{ github.repository }}:latest python --version
        docker run --rm ghcr.io/${{ github.repository }}:latest poetry --version
        
        # Test if main.py can be imported
        docker run --rm ghcr.io/${{ github.repository }}:latest poetry run python -c "import main; print('Import successful')"

  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-push, test-image]
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          Docker image for AppleMusicDecrypt
          
          **Image Details:**
          - Platform: linux/amd64
          - Base: Python 3.15 Alpine
          - Includes: GPAC, Bento4, FFmpeg
          
          **Usage:**
          ```bash
          docker pull ghcr.io/${{ github.repository }}:latest
          docker run -it --rm ghcr.io/${{ github.repository }}:latest
          ```
          
          Built from: ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
