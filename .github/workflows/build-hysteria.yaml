name: "Build Hysteria from external repository"

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Hysteria
    runs-on: ubuntu-latest
    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone Hysteria repository
        run: |
          git clone https://github.com/apernet/hysteria.git hysteria-src
          cd hysteria-src
          git checkout master

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r29
          add-to-path: false

      - name: Run build script (Windows only)
        working-directory: ./hysteria-src
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          export HY_APP_PLATFORMS="windows/amd64"
          python hyperbole.py build -r

      - name: Copy Windows executable to current repo
        run: |
          cp hysteria-src/build/hysteria-windows-amd64.exe ./
          rm -rf hysteria-src

      - name: Generate hash for Windows executable
        run: |
          sha256sum hysteria-windows-amd64.exe > hashes.txt

      - name: Commit and push build artifacts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Build Hysteria from apernet/hysteria - $(date)" || echo "No changes to commit"
          git checkout -b build-hysteria 2>/dev/null || git checkout build-hysteria
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin build-hysteria
